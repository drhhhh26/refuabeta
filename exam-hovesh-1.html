<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Security Headers -->
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://script.google.com https://script.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://*.google.com https://*.googleusercontent.com https://script.google.com https://script.googleusercontent.com;">

    <title>××‘×—×Ÿ ××§×“×™× ×—×•×‘×©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background: linear-gradient(135deg, #DCE5E1 0%, #f5f5f0 100%);
            min-height: 100vh;
            direction: rtl;
            padding: 20px 16px 40px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .header h1 {
            font-size: 1.8rem;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .header p {
            color: #718096;
            font-size: 0.95rem;
        }

        .info-form {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: 'Rubik', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #DC9450;
        }

        .start-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #DC9450 0%, #c77d3a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Rubik', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(220, 148, 80, 0.3);
            transition: all 0.3s ease;
        }

        .start-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #DC9450;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .question-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .question-card.submitted {
            pointer-events: none;
        }

        .question-number {
            color: #DC9450;
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .question-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .question-tag {
            font-size: 0.7rem;
            color: #a0aec0;
            font-weight: 500;
            text-align: right;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }

        .answer-option {
            background: #f7fafc;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .answer-option:active {
            transform: scale(0.98);
        }

        .answer-option.selected {
            background: rgba(220, 148, 80, 0.1);
            border-color: #DC9450;
        }

        .answer-option.correct {
            background: rgba(16, 185, 129, 0.15);
            border-color: #10b981;
            border-width: 3px;
        }

        .answer-option.incorrect {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
            border-width: 3px;
        }

        .answer-option input {
            margin-left: 12px;
        }

        .answer-option label {
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 1rem;
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Rubik', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .submit-btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            position: sticky;
            top: 20px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-home-btn {
            background: rgba(220, 148, 80, 0.15);
            border: 2px solid #DC9450;
            padding: 8px 16px;
            border-radius: 10px;
            font-family: 'Rubik', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: #DC9450;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: none;
        }

        .back-home-btn:active {
            transform: scale(0.95);
            background: rgba(220, 148, 80, 0.25);
        }

        .back-home-btn.show {
            display: block;
        }

        .progress-info {
            flex: 1;
            min-width: 0;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill-bar {
            height: 100%;
            background: linear-gradient(135deg, #DC9450 0%, #c77d3a 100%);
            transition: width 0.3s ease;
        }

        .success-message {
            background: white;
            padding: 40px 25px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .success-message h2 {
            color: #2d3748;
            font-size: 1.6rem;
            margin-bottom: 10px;
        }

        .success-message p {
            color: #718096;
            font-size: 1rem;
            margin-bottom: 25px;
        }

        .home-link {
            display: inline-block;
            padding: 14px 30px;
            background: #DC9450;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
        }

        #exam-form { display: none; }
        #success-screen { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ××¡×š ×¤×¨×˜×™× ××™×©×™×™× -->
        <div id="info-screen">
            <div class="header">
                <h1>ğŸ©¹ ××‘×—×Ÿ ××§×“×™× ×—×•×‘×©</h1>
                <p>25 ×©××œ×•×ª Â· ×˜×¨××•××” ×•×—×™×œ×•×¥</p>
            </div>

            <div class="info-form">
                <div class="form-group">
                    <label>×©× ××œ×</label>
                    <input type="text" id="student-name" placeholder="×”×–×Ÿ ×©× ××œ×">
                </div>

                <div class="form-group">
                    <label>××¡×¤×¨ ××™×©×™</label>
                    <input type="text" id="student-id" placeholder="×”×–×Ÿ ××¡×¤×¨ ××™×©×™">
                </div>

                <div class="form-group">
                    <label>×©× ×”×™×—×™×“×”</label>
                    <input type="text" id="student-unit" placeholder="×”×–×Ÿ ×©× ×”×™×—×™×“×”">
                </div>

                <button class="start-btn" id="start-btn" onclick="startExam()">×”×ª×—×œ ××‘×—×Ÿ</button>
            </div>
        </div>

        <!-- ××¡×š ×”××‘×—×Ÿ -->
        <div id="exam-form">
            <div class="progress-bar">
                <button class="back-home-btn" id="back-home-btn" onclick="goHome()">ğŸ  ×—×–×•×¨ ×œ×ª×¤×¨×™×˜</button>
                <div class="progress-info">
                    <div class="progress-text">×”×ª×§×“××•×ª: <span id="progress-num">0/25</span></div>
                    <div class="progress-fill">
                        <div class="progress-fill-bar" id="progress-bar"></div>
                    </div>
                </div>
            </div>

            <div id="questions-container"></div>

            <button class="submit-btn" id="submit-btn" onclick="submitExam()" disabled>
                <span id="submit-text">×©×œ×— ××‘×—×Ÿ (×¢× ×” ×¢×œ ×›×œ ×”×©××œ×•×ª)</span>
            </button>
        </div>

        <!-- ××¡×š ×”×¦×œ×—×” -->
        <div id="success-screen"></div>

        <!-- ××¡×š ×˜×¢×™× ×” -->
        <div id="loading-screen" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>×˜×•×¢×Ÿ ×©××œ×•×ª...</p>
        </div>
    </div>

    <script>
        // âš™ï¸ ×§×•× ×¤×™×’×•×¨×¦×™×” ×œ××‘×—×Ÿ - ××‘×—×Ÿ ×¤×ª×™×—×” ×—×•×‘×©
        const EXAM_CONFIG = {
            name: '××‘×—×Ÿ ×¤×ª×™×—×” ×—×•×‘×©',
            sheet: 'exam_hovesh_1'
        };

        // ğŸ”— Apps Script URLs
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBNcJzP2AIhXbVwYj-oDLmw_w0EPfPIqEuaX_rIsNj1ElMBgd30Fw2EHQ7hHubIIEw8g/exec?sheet=' + EXAM_CONFIG.sheet;
        const RESULTS_URL = 'https://script.google.com/macros/s/AKfycbzQ-px5HcK3nivAJwrHoRTDinTH7XthjXQQ5RQCiyi2nsL9GMnbZ-US_xljbTF7WmAe/exec';

        // ğŸ”— Apps Script URL ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª (×§×•×‘×¥ × ×¤×¨×“)
        const STATISTICS_URL = 'https://script.google.com/macros/s/AKfycbwId2JjtTY3swtq80B8MUsJ_CrPQPzWKHL5l1zj8cAX2185dc9r4o-aClPRKOeGXuVUSQ/exec';

        let examQuestions = [];
        let answers = {};

        // ×¤×•× ×§×¦×™×” ×œ×¢×¨×‘×•×‘ ××¢×¨×š (Fisher-Yates shuffle)
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // ×¤×•× ×§×¦×™×” ×œ×¢×¨×‘×•×‘ ×ª×©×•×‘×•×ª ×‘×›×œ ×©××œ×”
        function shuffleAnswers(questions) {
            return questions.map(q => {
                // ×™×¦×™×¨×ª ××¢×¨×š ×©×œ ×”×ª×©×•×‘×•×ª ×¢× ×”××™× ×“×§×¡ ×”××§×•×¨×™
                const answers = [
                    { text: q.answer1, originalIndex: 1 },
                    { text: q.answer2, originalIndex: 2 },
                    { text: q.answer3, originalIndex: 3 },
                    { text: q.answer4, originalIndex: 4 }
                ];

                // ×¢×¨×‘×•×‘ ×”×ª×©×•×‘×•×ª
                const shuffledAnswers = shuffleArray(answers);

                // ××¦×™××ª ×”××™× ×“×§×¡ ×”×—×“×© ×©×œ ×”×ª×©×•×‘×” ×”× ×›×•× ×”
                const newCorrectIndex = shuffledAnswers.findIndex(
                    a => a.originalIndex === q.correct
                ) + 1;

                return {
                    ...q,
                    answer1: shuffledAnswers[0].text,
                    answer2: shuffledAnswers[1].text,
                    answer3: shuffledAnswers[2].text,
                    answer4: shuffledAnswers[3].text,
                    correct: newCorrectIndex
                };
            });
        }

        // ×˜×¢×™× ×ª ×©××œ×•×ª ×-Google Sheets ×“×¨×š Apps Script
        async function loadQuestions() {
            try {
                console.log('ğŸ“¡ ×˜×•×¢×Ÿ ×©××œ×•×ª ×-' + EXAM_CONFIG.sheet);
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×');
                }

                examQuestions = data.questions.filter(q =>
                    q.question &&
                    q.question.toString().trim() !== '' &&
                    q.topic &&
                    q.difficulty &&
                    q.correct &&
                    parseInt(q.correct) >= 1 &&
                    parseInt(q.correct) <= 4
                );

                console.log('âœ… × ×˜×¢× ×• ' + examQuestions.length + ' ×©××œ×•×ª ××”×’×™×œ×™×•×Ÿ');

                if (examQuestions.length !== 25) {
                    throw new Error(`× ×“×¨×©×•×ª ×‘×“×™×•×§ 25 ×©××œ×•×ª ×ª×§×™× ×•×ª ×‘×’×™×œ×™×•×Ÿ, × ××¦××• ${examQuestions.length}`);
                }

                // ×¢×¨×‘×•×‘ ×ª×©×•×‘×•×ª ×•×©××œ×•×ª
                examQuestions = shuffleAnswers(examQuestions);
                examQuestions = shuffleArray(examQuestions);

                console.log('ğŸ”€ ×”×©××œ×•×ª ×•×”×ª×©×•×‘×•×ª ×¢×•×¨×‘×‘×•');
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×©××œ×•×ª:', error);
                throw error;
            }
        }


        // ×”×ª×—×œ×ª ××‘×—×Ÿ
        async function startExam() {
            const name = document.getElementById('student-name').value.trim();
            const id = document.getElementById('student-id').value.trim();
            const unit = document.getElementById('student-unit').value.trim();

            if (!name || !id || !unit) {
                alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }

            // ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×”×”×ª×—×œ×”
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = true;
            startBtn.textContent = '×˜×•×¢×Ÿ ×©××œ×•×ª...';

            try {
                await loadQuestions();
                displayQuestions();

                // ××¢×‘×¨ ×œ××¡×š ×”××‘×—×Ÿ
                document.getElementById('info-screen').style.display = 'none';
                document.getElementById('exam-form').style.display = 'block';
            } catch (error) {
                console.error('×©×’×™××”:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××‘×—×Ÿ: ' + error.message);
                
                // ×”×—×–×¨×ª ×”×›×¤×ª×•×¨ ×œ××¦×‘ ×ª×§×™×Ÿ
                startBtn.disabled = false;
                startBtn.textContent = '×”×ª×—×œ ××‘×—×Ÿ';
            }
        }

        // ×”×¦×’×ª ×©××œ×•×ª
        function displayQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            examQuestions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';

                // ×”××¨×ª difficulty ×œ××•×ª (Easy â†’ E, Medium â†’ M, Hard â†’ H)
                const difficultyTag = q.difficulty ? q.difficulty.charAt(0).toUpperCase() : '';
                // ×”××¨×ª topic ×œ××•×ª (trauma â†’ T, rescue â†’ R)
                const topicTag = q.topic === 'trauma' ? 'T' : 'R';

                card.innerHTML = `
                    <div class="question-number">×©××œ×” ${index + 1} ××ª×•×š 25</div>
                    <div class="question-text">${q.question}</div>
                    <div class="question-tag">${topicTag} | ${difficultyTag}</div>

                    <div class="answer-option" onclick="selectAnswer(${index}, 1)">
                        <label>
                            <input type="radio" name="q${index}" value="1">
                            ${q.answer1}
                        </label>
                    </div>

                    <div class="answer-option" onclick="selectAnswer(${index}, 2)">
                        <label>
                            <input type="radio" name="q${index}" value="2">
                            ${q.answer2}
                        </label>
                    </div>

                    <div class="answer-option" onclick="selectAnswer(${index}, 3)">
                        <label>
                            <input type="radio" name="q${index}" value="3">
                            ${q.answer3}
                        </label>
                    </div>

                    <div class="answer-option" onclick="selectAnswer(${index}, 4)">
                        <label>
                            <input type="radio" name="q${index}" value="4">
                            ${q.answer4}
                        </label>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ×‘×—×™×¨×ª ×ª×©×•×‘×”
        function selectAnswer(questionIndex, answerNum) {
            answers[questionIndex] = answerNum;
            
            const card = document.querySelectorAll('.question-card')[questionIndex];
            card.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            card.querySelectorAll('.answer-option')[answerNum - 1].classList.add('selected');
            card.querySelector(`input[value="${answerNum}"]`).checked = true;

            updateProgress();
        }

        // ×¢×“×›×•×Ÿ ×¤×¨×•×’×¨×¡
        function updateProgress() {
            const answered = Object.keys(answers).length;
            document.getElementById('progress-num').textContent = `${answered}/25`;
            document.getElementById('progress-bar').style.width = `${(answered / 25) * 100}%`;

            // ×”×¤×¢×œ×”/×”×©×‘×ª×” ×©×œ ×›×¤×ª×•×¨ ×”×©×œ×™×—×”
            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');

            if (answered === 25) {
                submitBtn.disabled = false;
                submitText.textContent = '×©×œ×— ××‘×—×Ÿ';
            } else {
                submitBtn.disabled = true;
                submitText.textContent = `×©×œ×— ××‘×—×Ÿ (${25 - answered} ×©××œ×•×ª × ×•×ª×¨×•)`;
            }
        }

        // ×©×œ×™×—×ª ××‘×—×Ÿ
        async function submitExam() {
            // ×‘×“×™×§×” ×©×¢× ×” ×¢×œ ×›×œ ×”×©××œ×•×ª
            if (Object.keys(answers).length < 25) {
                // ××¦×™××ª ×”×©××œ×” ×”×¨××©×•× ×” ×©×œ× × ×¢× ×ª×”
                for (let i = 0; i < 25; i++) {
                    if (!answers[i]) {
                        const cards = document.querySelectorAll('.question-card');
                        const unansweredCard = cards[i];
                        
                        // ×’×œ×™×œ×” ×œ×©××œ×”
                        unansweredCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // ×”×“×’×©×” ×–×× ×™×ª
                        unansweredCard.style.border = '3px solid #ef4444';
                        unansweredCard.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.5)';
                        
                        setTimeout(() => {
                            unansweredCard.style.border = '';
                            unansweredCard.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.08)';
                        }, 2000);
                        
                        alert(`×× × ×¢× ×” ×¢×œ ×©××œ×” ${i + 1} ×œ×¤× ×™ ×©×œ×™×—×ª ×”××‘×—×Ÿ`);
                        return;
                    }
                }
            }

            // ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×”×©×œ×™×—×” ×•×”×•×¡×¤×ª ×× ×™××¦×™×™×ª ×˜×¢×™× ×”
            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');
            submitBtn.disabled = true;
            submitText.innerHTML = '<div class="btn-spinner"></div> ×©×•×œ×— ××‘×—×Ÿ...';

            // ×—×™×©×•×‘ ×¦×™×•×Ÿ ×œ×¤×™ topic
            let traumaCorrect = 0;
            let rescueCorrect = 0;
            let traumaTotal = 0;
            let rescueTotal = 0;

            examQuestions.forEach((q, index) => {
                if (q.topic === 'trauma') {
                    traumaTotal++;
                    if (answers[index] === q.correct) traumaCorrect++;
                } else if (q.topic === 'rescue') {
                    rescueTotal++;
                    if (answers[index] === q.correct) rescueCorrect++;
                }
            });

            const traumaScore = traumaTotal > 0 ? Math.round((traumaCorrect / traumaTotal) * 100) : 0;
            const rescueScore = rescueTotal > 0 ? Math.round((rescueCorrect / rescueTotal) * 100) : 0;
            const totalScore = Math.round(((traumaCorrect + rescueCorrect) / 25) * 100);

            console.log(`ğŸ“Š ×˜×¨××•××”: ${traumaCorrect}/${traumaTotal} (${traumaScore}%) | ×—×™×œ×•×¥: ${rescueCorrect}/${rescueTotal} (${rescueScore}%)`);

            // ×©×œ×™×—×” ×œ-Google Sheets - ×ª×•×¦××•×ª ××™×©×™×•×ª
            const data = {
                timestamp: new Date().toLocaleString('he-IL', {
                    timeZone: 'Asia/Jerusalem',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                name: document.getElementById('student-name').value,
                id: document.getElementById('student-id').value,
                unit: document.getElementById('student-unit').value,
                exam: EXAM_CONFIG.name,
                traumaScore: traumaScore,
                rescueScore: rescueScore,
                totalScore: totalScore,
                score: (traumaCorrect + rescueCorrect),
                total: 25
            };

            console.log('ğŸ“¤ × ×ª×•× ×™× ×©× ×©×œ×—×™× ×œ-RESULTS_URL:', JSON.stringify(data, null, 2));
            console.log('ğŸ”— RESULTS_URL:', RESULTS_URL);

            // ×”×›× ×ª × ×ª×•× ×™ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×× ×•× ×™××™×™×
            const statistics = examQuestions.map((q, index) => ({
                exam_name: EXAM_CONFIG.name,
                question_text: q.question,
                topic: q.topic,
                difficulty: q.difficulty,
                is_correct: answers[index] === q.correct
            }));

            try {
                // ×©×œ×™×—×ª ×ª×•×¦××•×ª ××™×©×™×•×ª
                await fetch(RESULTS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                // ×©×œ×™×—×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª ×× ×•× ×™××™×•×ª ×œ×§×•×‘×¥ × ×¤×¨×“
                await fetch(STATISTICS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ statistics: statistics })
                });

                console.log('âœ… ×”××‘×—×Ÿ ×•×”×¡×˜×˜×™×¡×˜×™×§×•×ª × ×©×œ×—×• ×‘×”×¦×œ×—×” ×œ-Google Sheets');

                // ×”×¦×’×ª ×ª×©×•×‘×•×ª × ×›×•× ×•×ª ×•×©×’×•×™×•×ª
                try {
                    showResults();
                } catch (resultsError) {
                    console.error('×©×’×™××” ×‘×”×¦×’×ª ×ª×•×¦××•×ª:', resultsError);
                }

                // ×”×¦×’×ª ×›×¤×ª×•×¨ ×—×–×•×¨ ×œ×ª×¤×¨×™×˜
                document.getElementById('back-home-btn').classList.add('show');

                // ×©×™× ×•×™ ×”×›×¤×ª×•×¨ ×œ×”×¦×œ×—×”
                submitBtn.classList.add('success');
                submitText.innerHTML = 'âœ“ ×”××‘×—×Ÿ ×”×•×’×© ×‘×”×¦×œ×—×”! - × ×™×ª×Ÿ ×œ×¨××•×ª ××ª ×”×ª×•×¦××•×ª ×›×¢×ª';

                // ×’×œ×™×œ×” ×œ×¨××© ×”×“×£
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('×©×’×™××” ×‘×©×œ×™×—×”:', error);
                alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”××‘×—×Ÿ. ×× × × ×¡×” ×©× ×™×ª.');

                // ×”×—×–×¨×ª ×”×›×¤×ª×•×¨ ×œ××¦×‘ ×ª×§×™×Ÿ
                submitBtn.disabled = false;
                submitText.textContent = '×©×œ×— ××‘×—×Ÿ';
            }
        }

        // ×”×¦×’×ª ×ª×•×¦××•×ª
        function showResults() {
            const cards = document.querySelectorAll('.question-card');
            console.log(`ğŸ“Š ××¦×™×’ ×ª×•×¦××•×ª ×¢×‘×•×¨ ${examQuestions.length} ×©××œ×•×ª`);

            examQuestions.forEach((q, index) => {
                try {
                    const card = cards[index];
                    if (!card) {
                        console.error(`âŒ ×œ× × ××¦××” ×›×¨×˜×™×¡×™×™×” ×¢×‘×•×¨ ×©××œ×” ${index + 1}`);
                        return;
                    }

                    card.classList.add('submitted');

                    const options = card.querySelectorAll('.answer-option');
                    if (options.length < 4) {
                        console.error(`âŒ ×œ× × ××¦××• ××¡×¤×™×§ ××¤×©×¨×•×™×•×ª ×¢×‘×•×¨ ×©××œ×” ${index + 1}`);
                        return;
                    }

                    const userAnswer = answers[index];
                    const correctAnswer = parseInt(q.correct);

                    // ×•×•×œ×™×“×¦×™×” ×©×œ correctAnswer
                    if (!correctAnswer || correctAnswer < 1 || correctAnswer > 4) {
                        console.error(`âŒ ×©××œ×” ${index + 1}: ×ª×©×•×‘×” × ×›×•× ×” ×œ× ×ª×§×™× ×” (${q.correct})`);
                        return;
                    }

                    // ×¡×™××•×Ÿ ×”×ª×©×•×‘×” ×©×œ ×”××©×ª××©
                    if (userAnswer) {
                        if (userAnswer === correctAnswer) {
                            options[userAnswer - 1].classList.add('correct');
                        } else {
                            options[userAnswer - 1].classList.add('incorrect');
                            // ×¡×™××•×Ÿ ×”×ª×©×•×‘×” ×”× ×›×•× ×” ×’×
                            options[correctAnswer - 1].classList.add('correct');
                        }
                    } else {
                        // ×× ×œ× ×¢× ×” - ×¨×§ ×¡×™××•×Ÿ ×”×ª×©×•×‘×” ×”× ×›×•× ×”
                        options[correctAnswer - 1].classList.add('correct');
                    }

                    console.log(`âœ“ ×©××œ×” ${index + 1}: ×ª×©×•×‘×ª ××©×ª××©=${userAnswer}, ×ª×©×•×‘×” × ×›×•× ×”=${correctAnswer}`);
                } catch (error) {
                    console.error(`âŒ ×©×’×™××” ×‘×©××œ×” ${index + 1}:`, error);
                }
            });

            console.log('âœ… ×¡×™×•× ×”×¦×’×ª ×ª×•×¦××•×ª');
        }

        function goHome() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>