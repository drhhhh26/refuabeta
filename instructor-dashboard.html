<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¨×›×– ×‘×§×¨×” | ××“×•×¨ ×¨×¤×•××”</title>

    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://script.google.com https://script.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://script.google.com https://script.googleusercontent.com;">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --orange-primary: #FF6B35;
            --orange-bright: #FF8C42;
            --orange-dark: #E85A24;
            --orange-glow: rgba(255, 107, 53, 0.4);
            --charcoal: #1a1d23;
            --charcoal-light: #252931;
            --charcoal-lighter: #2f343d;
            --charcoal-dark: #13151a;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-light: rgba(255, 255, 255, 0.1);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.3);
            --error: #ef4444;
            --error-glow: rgba(239, 68, 68, 0.3);
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Heebo', sans-serif;
            background: var(--charcoal-dark);
            min-height: 100vh;
            direction: rtl;
            overflow-x: hidden;
            color: var(--text-primary);
        }

        /* ===== HEADER BAR ===== */
        .admin-header {
            background: var(--charcoal);
            border-bottom: 1px solid var(--border-subtle);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .admin-logo-text h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .admin-logo-text span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px 14px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #fca5a5;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--error);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 var(--error-glow); }
            50% { opacity: 0.7; box-shadow: 0 0 0 8px transparent; }
        }

        .admin-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-btn {
            background: var(--charcoal-light);
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 10px;
            font-family: 'Heebo', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .header-btn:hover {
            background: var(--charcoal-lighter);
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }

        /* ===== MAIN CONTAINER ===== */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* ===== EXAM CONTROL PANEL ===== */
        .control-panel {
            background: linear-gradient(135deg, var(--charcoal-light) 0%, var(--charcoal) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .control-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--orange-primary), var(--orange-bright), var(--orange-primary));
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .control-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .control-panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-panel-title i {
            font-size: 1.5rem;
            color: var(--orange-primary);
        }

        .control-panel-title h2 {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .control-panel-title span {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-right: 8px;
        }

        .refresh-btn {
            background: var(--charcoal-lighter);
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 10px;
            font-family: 'Heebo', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }

        .refresh-btn.spinning i {
            animation: spin 1s linear infinite;
        }

        .exam-controls-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .exam-control-card {
            background: var(--charcoal-lighter);
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .exam-control-card.active {
            border-color: var(--success);
            box-shadow: 0 0 20px var(--success-glow);
        }

        .exam-control-card.inactive {
            border-color: var(--error);
            opacity: 0.7;
        }

        .exam-control-card:hover {
            transform: translateY(-4px);
        }

        .exam-card-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .exam-card-name {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .exam-card-type {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .exam-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .exam-status-badge.on {
            background: rgba(16, 185, 129, 0.15);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .exam-status-badge.off {
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .exam-toggle-btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            font-family: 'Heebo', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .exam-toggle-btn.turn-off {
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .exam-toggle-btn.turn-off:hover {
            background: var(--error);
            color: white;
        }

        .exam-toggle-btn.turn-on {
            background: rgba(16, 185, 129, 0.15);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .exam-toggle-btn.turn-on:hover {
            background: var(--success);
            color: white;
        }

        .exam-toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--charcoal-light);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--orange-primary);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-card-icon {
            width: 40px;
            height: 40px;
            background: var(--charcoal-lighter);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .stat-trend.up {
            background: rgba(16, 185, 129, 0.15);
            color: #6ee7b7;
        }

        .stat-trend.down {
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
        }

        .stat-trend.neutral {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-muted);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* ===== TWO COLUMN LAYOUT ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .dashboard-panel {
            background: var(--charcoal-light);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .panel-title i {
            color: var(--orange-primary);
        }

        .panel-action {
            font-size: 0.85rem;
            color: var(--orange-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .panel-action:hover {
            text-decoration: underline;
        }

        .panel-content {
            padding: 20px;
        }

        /* ===== PROBLEM QUESTIONS LIST ===== */
        .problem-question {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 14px;
            background: var(--charcoal-lighter);
            border-radius: 12px;
            margin-bottom: 10px;
            border-right: 4px solid var(--error);
            transition: all 0.3s ease;
        }

        .problem-question:hover {
            transform: translateX(-4px);
            background: rgba(239, 68, 68, 0.08);
        }

        .problem-question:last-child {
            margin-bottom: 0;
        }

        .problem-rank {
            width: 32px;
            height: 32px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #fca5a5;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .problem-content {
            flex: 1;
            min-width: 0;
        }

        .problem-text {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .problem-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .problem-rate {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--error);
        }

        .mini-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .mini-badge.trauma { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
        .mini-badge.rescue { background: rgba(16, 185, 129, 0.15); color: #6ee7b7; }
        .mini-badge.easy { background: rgba(59, 130, 246, 0.15); color: #93c5fd; }
        .mini-badge.medium { background: rgba(245, 158, 11, 0.15); color: #fcd34d; }
        .mini-badge.hard { background: rgba(236, 72, 153, 0.15); color: #f9a8d4; }

        /* ===== DISTRIBUTION CHART ===== */
        .distribution-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .distribution-item:last-child {
            margin-bottom: 0;
        }

        .distribution-label {
            width: 120px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .distribution-bar-container {
            flex: 1;
            height: 24px;
            background: var(--charcoal-lighter);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .distribution-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--orange-primary), var(--orange-bright));
            border-radius: 6px;
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-left: 10px;
        }

        .distribution-value {
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            padding-right: 8px;
        }

        .distribution-count {
            width: 50px;
            text-align: left;
            font-size: 0.85rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        /* ===== FULL WIDTH SECTIONS ===== */
        .full-panel {
            background: var(--charcoal-light);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .chart-container {
            height: 300px;
            padding: 20px;
        }

        /* ===== FILTERS BAR ===== */
        .filters-bar {
            background: var(--charcoal-light);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .filters-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .filter-label i {
            color: var(--orange-primary);
        }

        .filter-select, .filter-input {
            background: var(--charcoal-lighter);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 10px;
            font-family: 'Heebo', sans-serif;
            font-size: 0.9rem;
            min-width: 150px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--orange-primary);
        }

        .filter-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'Heebo', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        .filter-btn.primary {
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));
            color: white;
        }

        .filter-btn.primary:hover {
            box-shadow: 0 5px 20px var(--orange-glow);
            transform: translateY(-2px);
        }

        .filter-btn.secondary {
            background: var(--charcoal-lighter);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }

        .filter-btn.secondary:hover {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }

        .filter-spacer {
            flex: 1;
        }

        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--charcoal-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--charcoal-lighter);
            border-top: 4px solid var(--orange-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* ===== PASSWORD MODAL ===== */
        .password-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .password-box {
            background: var(--charcoal-light);
            border: 1px solid var(--border-subtle);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 420px;
            width: 90%;
            animation: slideUp 0.4s ease-out;
        }

        .password-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 2rem;
        }

        .password-box h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .password-box p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .password-input {
            width: 100%;
            padding: 16px;
            background: var(--charcoal-lighter);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 1.1rem;
            font-family: 'Heebo', sans-serif;
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 16px;
            transition: border-color 0.3s ease;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--orange-primary);
        }

        .password-input.error {
            border-color: var(--error);
            animation: shake 0.5s ease;
        }

        .password-submit {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .password-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--orange-glow);
        }

        .password-back {
            width: 100%;
            padding: 14px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .password-back:hover {
            background: var(--charcoal-lighter);
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }

        .error-message {
            color: var(--error);
            margin-top: 12px;
            font-size: 0.9rem;
            display: none;
        }

        .error-message.show { display: block; }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .exam-controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-container { padding: 16px; }
            .admin-header { padding: 12px 16px; flex-wrap: wrap; gap: 12px; }
            .admin-logo-text h1 { font-size: 1rem; }
            .exam-controls-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .filters-row { flex-direction: column; align-items: stretch; }
            .filter-select, .filter-input { width: 100%; }
            .filter-spacer { display: none; }
            .stat-value { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <!-- Password Modal -->
    <div id="passwordModal" class="password-modal">
        <div class="password-box">
            <div class="password-icon"><i class="fas fa-shield-alt"></i></div>
            <h2>××¨×›×– ×‘×§×¨×”</h2>
            <p>×’×™×©×” ×œ××“×¨×™×›×™× ××•×¨×©×™× ×‘×œ×‘×“</p>
            <input type="password" id="passwordInput" class="password-input" placeholder="×”×–×Ÿ ×¡×™×¡××”" autocomplete="off">
            <button onclick="checkPassword()" class="password-submit">
                <i class="fas fa-sign-in-alt"></i> ×›× ×™×¡×” ×œ××¢×¨×›×ª
            </button>
            <button onclick="window.location.href='index.html'" class="password-back">
                <i class="fas fa-arrow-right"></i> ×—×–×¨×” ×œ×¢××•×“ ×”×‘×™×ª
            </button>
            <div id="errorMessage" class="error-message">×¡×™×¡××” ×©×’×•×™×”, × ×¡×” ×©× ×™×ª</div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <!-- Header -->
        <header class="admin-header">
            <div class="admin-header-right">
                <div class="admin-logo">
                    <div class="admin-logo-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="admin-logo-text">
                        <h1>××¨×›×– ×‘×§×¨×”</h1>
                        <span>××“×•×¨ ×¨×¤×•××” - ×‘××´×¤ ×”×¢×•×¨×£</span>
                    </div>
                </div>
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    LIVE
                </div>
            </div>
            <div class="admin-header-left">
                <a href="index.html" class="header-btn">
                    <i class="fas fa-home"></i>
                    ×¢××•×“ ×”×‘×™×ª
                </a>
            </div>
        </header>

        <div class="main-container">
            <!-- Exam Control Panel -->
            <section class="control-panel">
                <div class="control-panel-header">
                    <div class="control-panel-title">
                        <i class="fas fa-gamepad"></i>
                        <h2>×‘×§×¨×ª ××‘×—× ×™×</h2>
                        <span>×”×¤×¢×œ ××• ×”×©×‘×ª ××‘×—× ×™× ×‘×–××Ÿ ×××ª</span>
                    </div>
                    <button class="refresh-btn" onclick="refreshExamStatuses()">
                        <i class="fas fa-sync-alt"></i>
                        ×¨×¢× ×Ÿ ×¡×˜×˜×•×¡
                    </button>
                </div>
                <div id="examControlsGrid" class="exam-controls-grid">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Stats Grid -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon">ğŸ“</div>
                        <div class="stat-trend neutral" id="answersTrend">
                            <i class="fas fa-minus"></i> --
                        </div>
                    </div>
                    <div class="stat-value" id="totalAnswers">0</div>
                    <div class="stat-label">×¡×”"×› ×ª×©×•×‘×•×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon">ğŸ‘¥</div>
                        <div class="stat-trend neutral" id="studentsTrend">
                            <i class="fas fa-minus"></i> --
                        </div>
                    </div>
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">× ×‘×—× ×™× (×”×¢×¨×›×”)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon">âœ…</div>
                        <div class="stat-trend neutral" id="successTrend">
                            <i class="fas fa-minus"></i> --
                        </div>
                    </div>
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">××—×•×– ×”×¦×œ×—×” ×›×œ×œ×™</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon">ğŸ“…</div>
                        <div class="stat-trend neutral">
                            <i class="fas fa-clock"></i> ×”×™×•×
                        </div>
                    </div>
                    <div class="stat-value" id="todayStudents">0</div>
                    <div class="stat-label">× ×‘×—× ×™× ×”×™×•×</div>
                </div>
            </section>

            <!-- Two Column Layout -->
            <section class="dashboard-grid">
                <!-- Problem Questions -->
                <div class="dashboard-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-fire"></i>
                            ×©××œ×•×ª ×‘×¢×™×™×ª×™×•×ª
                        </div>
                    </div>
                    <div class="panel-content" id="problemQuestions">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Exam Distribution -->
                <div class="dashboard-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-chart-pie"></i>
                            ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××‘×—×Ÿ
                        </div>
                    </div>
                    <div class="panel-content" id="examDistribution">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <section class="filters-bar">
                <div class="filters-row">
                    <div class="filter-label">
                        <i class="fas fa-filter"></i>
                        ×¡×™× ×•×Ÿ:
                    </div>
                    <select id="filterExam" class="filter-select">
                        <option value="all">×›×œ ×”××‘×—× ×™×</option>
                        <option value="××‘×—×Ÿ ×¤×ª×™×—×” ×—×•×‘×©">××‘×—×Ÿ ×¤×ª×™×—×” ×—×•×‘×©</option>
                        <option value="××‘×—×Ÿ ×¡×™×•× ×—×•×‘×©">××‘×—×Ÿ ×¡×™×•× ×—×•×‘×©</option>
                        <option value="××‘×—×Ÿ ×¤×ª×™×—×” ××˜×´×‘">××‘×—×Ÿ ×¤×ª×™×—×” ××˜×´×‘</option>
                        <option value="××‘×—×Ÿ ×¡×™×•× ××˜×´×‘">××‘×—×Ÿ ×¡×™×•× ××˜×´×‘</option>
                    </select>
                    <select id="filterTopic" class="filter-select">
                        <option value="all">×›×œ ×”× ×•×©××™×</option>
                        <option value="trauma">×˜×¨××•××”</option>
                        <option value="rescue">×—×™×œ×•×¥</option>
                    </select>
                    <select id="filterDifficulty" class="filter-select">
                        <option value="all">×›×œ ×”×¨××•×ª</option>
                        <option value="Easy">×§×œ</option>
                        <option value="Medium">×‘×™× ×•× ×™</option>
                        <option value="Hard">×§×©×”</option>
                    </select>
                    <input type="date" id="filterDate" class="filter-input">
                    <div class="filter-spacer"></div>
                    <button class="filter-btn primary" onclick="applyFilters()">
                        <i class="fas fa-check"></i> ×”×—×œ
                    </button>
                    <button class="filter-btn secondary" onclick="resetFilters()">
                        <i class="fas fa-undo"></i> ××¤×¡
                    </button>
                </div>
            </section>

            <!-- Success Rate Trend Chart -->
            <section class="full-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-chart-line"></i>
                        ××’××ª ×”×¦×œ×—×” ×œ×¤×™ ×§×•×©×™
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="difficultyChart"></canvas>
                </div>
            </section>

            <!-- Questions Success Chart -->
            <section class="full-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-bullseye"></i>
                        ××—×•×– ×”×¦×œ×—×” ×œ×¤×™ ×©××œ×” (10 ×”× ×¤×•×¦×•×ª)
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="questionsChart"></canvas>
                </div>
            </section>
        </div>
    </div>

    <script>
        const STATISTICS_URL = 'https://script.google.com/macros/s/AKfycbwId2JjtTY3swtq80B8MUsJ_CrPQPzWKHL5l1zj8cAX2185dc9r4o-aClPRKOeGXuVUSQ/exec';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBNcJzP2AIhXbVwYj-oDLmw_w0EPfPIqEuaX_rIsNj1ElMBgd30Fw2EHQ7hHubIIEw8g/exec';
        const CORRECT_PASSWORDS = ['×¨×¤×•××”2025', 'refua2025'];
        const EXAM_CONFIG = [
            { name: '××‘×—×Ÿ ×¤×ª×™×—×” ×—×•×‘×©', icon: 'ğŸ©¹', type: '×—×•×‘×©' },
            { name: '××‘×—×Ÿ ×¡×™×•× ×—×•×‘×©', icon: 'âœ…', type: '×—×•×‘×©' },
            { name: '××‘×—×Ÿ ×¤×ª×™×—×” ××˜×´×‘', icon: 'ğŸ‘¨â€âš•ï¸', type: '××˜×´×‘' },
            { name: '××‘×—×Ÿ ×¡×™×•× ××˜×´×‘', icon: 'ğŸ†', type: '××˜×´×‘' }
        ];

        let allData = [];
        let filteredData = [];
        let charts = {};
        let examStatuses = {};

        // ===== PASSWORD =====
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const password = input.value;
            const errorMsg = document.getElementById('errorMessage');

            if (CORRECT_PASSWORDS.includes(password)) {
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('loadingOverlay').style.display = 'flex';
                initDashboard();
            } else {
                input.classList.add('error');
                errorMsg.classList.add('show');
                input.value = '';
                setTimeout(() => { input.classList.remove('error'); }, 500);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkPassword();
            });
            passwordInput.focus();
        });

        // ===== INIT =====
        async function initDashboard() {
            try {
                await Promise.all([loadData(), loadExamStatuses()]);
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div style="color: var(--error); text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</div>
                        <div style="color: var(--text-muted);">${error.message}</div>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: var(--orange-primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-family: 'Heebo';">× ×¡×” ×©×•×‘</button>
                    </div>
                `;
            }
        }

        // ===== LOAD DATA =====
        async function loadData() {
            const response = await fetch(STATISTICS_URL);
            const data = await response.json();

            if (!data.success) throw new Error(data.error || 'Error loading data');

            allData = data.statistics.filter(s => s.question_text && s.question_text.toString().trim() !== '');
            filteredData = [...allData];

            updateDashboard();
        }

        // ===== LOAD EXAM STATUSES =====
        async function loadExamStatuses() {
            const response = await fetch(SCRIPT_URL + '?sheet=switch');
            const data = await response.json();

            if (!data.success) throw new Error(data.error || 'Error loading exam status');

            examStatuses = data.switches;
            renderExamControls();
        }

        async function refreshExamStatuses() {
            const btn = document.querySelector('.refresh-btn');
            btn.classList.add('spinning');
            btn.disabled = true;

            try {
                await loadExamStatuses();
            } catch (error) {
                console.error('Refresh error:', error);
            } finally {
                btn.classList.remove('spinning');
                btn.disabled = false;
            }
        }

        // ===== RENDER EXAM CONTROLS =====
        function renderExamControls() {
            const container = document.getElementById('examControlsGrid');
            container.innerHTML = '';

            EXAM_CONFIG.forEach(exam => {
                const status = examStatuses[exam.name] || 'ON';
                const isOn = status === 'ON';

                const card = document.createElement('div');
                card.className = `exam-control-card ${isOn ? 'active' : 'inactive'}`;
                card.id = `exam-card-${exam.name.replace(/\s/g, '-')}`;

                card.innerHTML = `
                    <div class="exam-card-icon">${exam.icon}</div>
                    <div class="exam-card-name">${exam.name}</div>
                    <div class="exam-card-type">${exam.type}</div>
                    <div class="exam-status-badge ${isOn ? 'on' : 'off'}">
                        <i class="fas fa-circle" style="font-size: 8px;"></i>
                        ${isOn ? '×¤×¢×™×œ' : '××•×©×‘×ª'}
                    </div>
                    <button class="exam-toggle-btn ${isOn ? 'turn-off' : 'turn-on'}" onclick="toggleExam('${exam.name}', ${!isOn})">
                        <i class="fas fa-${isOn ? 'stop' : 'play'}"></i>
                        ${isOn ? '×”×©×‘×ª ××‘×—×Ÿ' : '×”×¤×¢×œ ××‘×—×Ÿ'}
                    </button>
                `;

                container.appendChild(card);
            });
        }

        async function toggleExam(examName, turnOn) {
            const cardId = `exam-card-${examName.replace(/\s/g, '-')}`;
            const card = document.getElementById(cardId);
            const btn = card.querySelector('.exam-toggle-btn');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××¢×“×›×Ÿ...';

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=updateSwitch&examName=${encodeURIComponent(examName)}&status=${turnOn ? 'ON' : 'OFF'}`
                });

                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Error updating');

                examStatuses[examName] = turnOn ? 'ON' : 'OFF';
                renderExamControls();

            } catch (error) {
                console.error('Toggle error:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”××‘×—×Ÿ');
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-${turnOn ? 'play' : 'stop'}"></i> ${turnOn ? '×”×¤×¢×œ ××‘×—×Ÿ' : '×”×©×‘×ª ××‘×—×Ÿ'}`;
            }
        }

        // ===== UPDATE DASHBOARD =====
        function updateDashboard() {
            updateStats();
            updateProblemQuestions();
            updateExamDistribution();
            updateCharts();
        }

        function updateStats() {
            const totalAnswers = filteredData.length;
            const estimatedStudents = Math.ceil(totalAnswers / 25);
            const correctAnswers = filteredData.filter(d => d.is_correct === true || d.is_correct === 'TRUE').length;
            const successRate = totalAnswers > 0 ? Math.round((correctAnswers / totalAnswers) * 100) : 0;

            // Today's stats
            const today = new Date().toISOString().split('T')[0];
            const todayData = allData.filter(d => {
                if (!d.timestamp) return false;
                const recordDate = d.timestamp instanceof Date
                    ? d.timestamp.toISOString().split('T')[0]
                    : new Date(d.timestamp).toISOString().split('T')[0];
                return recordDate === today;
            });
            const todayStudents = Math.ceil(todayData.length / 25);

            document.getElementById('totalAnswers').textContent = totalAnswers.toLocaleString();
            document.getElementById('totalStudents').textContent = estimatedStudents;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('todayStudents').textContent = todayStudents;
        }

        function updateProblemQuestions() {
            const questionStats = {};
            filteredData.forEach(d => {
                const q = d.question_text;
                if (!questionStats[q]) questionStats[q] = { question: q, topic: d.topic, difficulty: d.difficulty, total: 0, correct: 0 };
                questionStats[q].total++;
                if (d.is_correct === true || d.is_correct === 'TRUE') questionStats[q].correct++;
            });

            const questions = Object.values(questionStats)
                .filter(q => q.total >= 3)
                .map(q => ({ ...q, rate: Math.round((q.correct / q.total) * 100) }))
                .sort((a, b) => a.rate - b.rate)
                .slice(0, 5);

            const container = document.getElementById('problemQuestions');

            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <div>××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™× ×œ×”×¦×’×”</div>
                        <div style="font-size: 0.85rem; margin-top: 8px;">× ×“×¨×©×•×ª ×œ×¤×—×•×ª 3 ×ª×©×•×‘×•×ª ×œ×›×œ ×©××œ×”</div>
                    </div>
                `;
                return;
            }

            // Build problem questions safely using DOM methods to prevent XSS
            questions.forEach((q, i) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'problem-question';

                const rankDiv = document.createElement('div');
                rankDiv.className = 'problem-rank';
                rankDiv.textContent = i + 1;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'problem-content';

                const textDiv = document.createElement('div');
                textDiv.className = 'problem-text';
                textDiv.textContent = q.question;

                const metaDiv = document.createElement('div');
                metaDiv.className = 'problem-meta';

                const rateSpan = document.createElement('span');
                rateSpan.className = 'problem-rate';
                rateSpan.textContent = `${q.rate}% ×”×¦×œ×—×”`;

                const topicBadge = document.createElement('span');
                topicBadge.className = `mini-badge ${q.topic}`;
                topicBadge.textContent = q.topic === 'trauma' ? '×˜×¨××•××”' : '×—×™×œ×•×¥';

                const diffBadge = document.createElement('span');
                diffBadge.className = `mini-badge ${q.difficulty.toLowerCase()}`;
                diffBadge.textContent = q.difficulty === 'Easy' ? '×§×œ' : q.difficulty === 'Medium' ? '×‘×™× ×•× ×™' : '×§×©×”';

                metaDiv.appendChild(rateSpan);
                metaDiv.appendChild(topicBadge);
                metaDiv.appendChild(diffBadge);
                contentDiv.appendChild(textDiv);
                contentDiv.appendChild(metaDiv);
                questionDiv.appendChild(rankDiv);
                questionDiv.appendChild(contentDiv);
                container.appendChild(questionDiv);
            });
        }

        function updateExamDistribution() {
            const examCounts = {};
            filteredData.forEach(d => {
                const exam = d.exam_name || '×œ× ×™×“×•×¢';
                examCounts[exam] = (examCounts[exam] || 0) + 1;
            });

            const total = filteredData.length || 1;
            const exams = Object.entries(examCounts)
                .map(([name, count]) => ({ name, count, percent: Math.round((count / total) * 100) }))
                .sort((a, b) => b.count - a.count);

            const container = document.getElementById('examDistribution');

            if (exams.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-pie"></i>
                        <div>××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>
                    </div>
                `;
                return;
            }

            // Build exam distribution safely using DOM methods to prevent XSS
            exams.forEach(exam => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'distribution-item';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'distribution-label';
                labelDiv.textContent = exam.name.replace('××‘×—×Ÿ ', '');

                const barContainerDiv = document.createElement('div');
                barContainerDiv.className = 'distribution-bar-container';

                const barDiv = document.createElement('div');
                barDiv.className = 'distribution-bar';
                barDiv.style.width = `${exam.percent}%`;

                const valueSpan = document.createElement('span');
                valueSpan.className = 'distribution-value';
                valueSpan.textContent = `${exam.percent}%`;

                barDiv.appendChild(valueSpan);
                barContainerDiv.appendChild(barDiv);

                const countDiv = document.createElement('div');
                countDiv.className = 'distribution-count';
                countDiv.textContent = exam.count;

                itemDiv.appendChild(labelDiv);
                itemDiv.appendChild(barContainerDiv);
                itemDiv.appendChild(countDiv);
                container.appendChild(itemDiv);
            });
        }

        function updateCharts() {
            updateDifficultyChart();
            updateQuestionsChart();
        }

        function updateDifficultyChart() {
            const difficulties = ['Easy', 'Medium', 'Hard'];
            const wrongCounts = difficulties.map(diff => {
                const data = filteredData.filter(d => d.difficulty === diff);
                return data.filter(d => d.is_correct === false || d.is_correct === 'FALSE').length;
            });

            if (charts.difficulty) charts.difficulty.destroy();

            const ctx = document.getElementById('difficultyChart').getContext('2d');
            charts.difficulty = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['×§×œ', '×‘×™× ×•× ×™', '×§×©×”'],
                    datasets: [{
                        label: '×ª×©×•×‘×•×ª ×©×’×•×™×•×ª',
                        data: wrongCounts,
                        backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(239, 68, 68, 0.7)'],
                        borderColor: ['rgba(59, 130, 246, 1)', 'rgba(245, 158, 11, 1)', 'rgba(239, 68, 68, 1)'],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#9ca3af', font: { family: 'Heebo' } }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { ticks: { color: '#9ca3af', font: { family: 'Heebo' } }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateQuestionsChart() {
            const questionStats = {};
            filteredData.forEach(d => {
                const q = d.question_text;
                if (!questionStats[q]) questionStats[q] = { total: 0, correct: 0 };
                questionStats[q].total++;
                if (d.is_correct === true || d.is_correct === 'TRUE') questionStats[q].correct++;
            });

            const questions = Object.keys(questionStats).map(q => ({
                question: q,
                rate: Math.round((questionStats[q].correct / questionStats[q].total) * 100),
                total: questionStats[q].total
            }));

            questions.sort((a, b) => b.total - a.total);
            const top10 = questions.slice(0, 10);

            if (charts.questions) charts.questions.destroy();

            const ctx = document.getElementById('questionsChart').getContext('2d');
            charts.questions = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(q => q.question.length > 45 ? q.question.substring(0, 45) + '...' : q.question),
                    datasets: [{
                        label: '××—×•×– ×”×¦×œ×—×”',
                        data: top10.map(q => q.rate),
                        backgroundColor: top10.map(q => {
                            if (q.rate >= 80) return 'rgba(16, 185, 129, 0.7)';
                            if (q.rate >= 60) return 'rgba(245, 158, 11, 0.7)';
                            return 'rgba(239, 68, 68, 0.7)';
                        }),
                        borderWidth: 0,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%', color: '#9ca3af', font: { family: 'Heebo' } }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#9ca3af', font: { family: 'Heebo', size: 11 } }, grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: ctx => top10[ctx[0].dataIndex].question,
                                label: ctx => '××—×•×– ×”×¦×œ×—×”: ' + ctx.parsed.x + '%'
                            }
                        }
                    }
                }
            });
        }

        // ===== FILTERS =====
        function applyFilters() {
            const exam = document.getElementById('filterExam').value;
            const topic = document.getElementById('filterTopic').value;
            const difficulty = document.getElementById('filterDifficulty').value;
            const filterDate = document.getElementById('filterDate').value;

            filteredData = allData.filter(d => {
                if (exam !== 'all' && d.exam_name !== exam) return false;
                if (topic !== 'all' && d.topic !== topic) return false;
                if (difficulty !== 'all' && d.difficulty !== difficulty) return false;
                if (filterDate) {
                    const timestamp = d.timestamp;
                    if (!timestamp) return false;
                    let recordDate = timestamp instanceof Date ? timestamp.toISOString().split('T')[0] : new Date(timestamp).toISOString().split('T')[0];
                    if (recordDate !== filterDate) return false;
                }
                return true;
            });

            updateDashboard();
        }

        function resetFilters() {
            document.getElementById('filterExam').value = 'all';
            document.getElementById('filterTopic').value = 'all';
            document.getElementById('filterDifficulty').value = 'all';
            document.getElementById('filterDate').value = '';
            filteredData = [...allData];
            updateDashboard();
        }
    </script>
</body>
</html>
